---
title:        "浏览器缓存"
# jekyll-seo-tag
description:  "浏览器缓存"
author:       "junxiachen"
---

浏览器缓存，既是网页性能优化里面静态资源相关优化的一大利器，也是很多 web 开发人员在工作过程中不可避免的一大问题。对于浏览器缓存的态度在不同的场景，我们可能有不同的需求。比如在开发的时候我们希望能避免缓存的产生，在产品发布后我们又想要利用缓存来提升网页的打开速度。    

## 基本知识   
浏览器缓存可以分为强缓存和协商缓存。这里通过一张表来表现两者的区别：    

|     |获取资源形式|状态码     |发送请求到服务器     |
|-----|----------|----------|------------------|
|强缓存|从缓存取   |200 ( from cache ) |否，直接从缓存中取 |
|协商缓存|从缓存取  |304 （ Not Modified ） |否，通过服务器来告知缓存是否可用|
     
页面的缓存状态是由 header 决定的， header 的参数有四种：Expires、Cache-Control、Last-Modified/If-Modified-Since、ETag/If-None-Match

### 强缓存--Expires    
缓存过期时间，用来指定资源到期的时间，是服务器端的具体的时间点，用 GMT 格式的字符串表示，如： Expires:Thu,31 Dec 2037 23:55:55 GMT。Expires 是 Web 服务器响应消息头字段，在响应 http 请求时告诉浏览器在过期时间前浏览器可以直接从浏览器缓存取数据，而无需再次请求。    
Expires 是较老的强缓存管理 header ，由于它是服务器返回的一个绝对时间，在服务器时间与客户端时间相差较大时，缓存管理容易出现问题。比如我们随意地修改下客户端的时间，就能影响缓存命中的结果。所以，在 http1.1 的时候，提出了一个新的 header，就是 Cache-Control 。     

### 强缓存--Cache-Control     
Cache-Control 是一个相对时间，可以用 max-age 来指定设置缓存最大的有效时间，如 Cache-Control:max-age=315360000，单位是秒。这样当浏览器向服务器发送请求后，在 max-age 这段时间里浏览器就不会再向服务器发送请求了。
Cache-Control 描述的是相对时间，在进行缓存命中的时候，都是利用客户端时间进行判断。因此，相比起 Expires ， Cache-Control 的缓存管理更有效，更安全。
这两个 header 可以同时启用也可以只启用一个。当两者同时存在的时候，Cache-Control 的优先级高于 Expires 。
   
### 协商缓存--Last-Modified/If-Modified-Since     
服务器端文件的最后修改时间，需要和 cache-control 共同使用，是检查服务器端资源是否更新的一种方式。当浏览器再次进行请求时，会向服务器传送 If-Modified-Since 报头，询问 Last-Modified 时间点之后资源是否被修改过。如果没有修改，则返回码为304，使用缓存；如果修改过，则再次去服务器请求资源，返回码和首次请求相同为200，资源为服务器最新资源。
Last-Modified/If-Modified-Since 都是根据服务器时间返回的 header ，一般来说，在没有调整服务器时间和篡改客户端缓存的情况下，这两个 header 配合起来管理协商缓存是非常可靠的。但也存在有的时候服务器上资源发生的变化，但是最后修改时间却没有改变的情况。发生这种情况主要是因为这个 header 的时间是精确到秒的。在这种情况下，就有影响到协商缓存的可靠性。所以就有了另外一对 header 来管理协商缓存， ETag/If-None-Match 。     

### 协商缓存--ETag/If-None-Match    
根据实体内容生成一段 hash 字符串，标识资源的状态，由服务端产生。浏览器会将这串字符串传回服务器，验证资源是否已经修改，如果没有修改则从缓存中读取。    

使用ETag可以解决 Last-Modified 存在的一些问题：    

1. 某些服务器不能精确得到资源的最后修改时间，这样就无法通过最后修改时间判断资源是否更新。
2. 如果资源修改非常频繁，在秒以下的时间内进行修改，Last-Modified 只能精确到秒。
3. 一些资源的最后修改时间改变了，但是内容没改变，使用 ETag 就认为资源还是没有修改的。    

## 用户行为对缓存的影响  
   
|用户操作       |Expires/Cache-Control|Last-Modified/ETag|
|--------------|---------------------|------------------|
|地址栏回车     |有效|有效|
|页面链接跳转    |有效|有效|
|新开窗口       |有效|有效|
|前进后退       |有效|有效|
|F5刷新        |有效|有效|
|Ctrl+F5强制刷新|有效|有效|        
    
## 协商缓存的管理     
由于强缓存不发请求到服务器，所以有时候资源更新了浏览器还不知道。而协商缓存会发请求到服务器，所以大部分情况下资源更新都会知道。因此，大部分的 web 服务器都默认开启协商缓存，而且是同时启用两对请求头。
